<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="static/style.css">
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <title>Kitty Fuzzer</title>
</head>
<body>

    <div id="body">
        <script src="js/jquery-1.11.1.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/hexdump.js"></script>
        <!--

        +======================+===============+======================+
        | Session info         | Stages        |       Reports        |
        +                      |               +=======+======+=======+
        |                      |               |  rep# | time | type  |
        |========+=============+               +=======+======+=======+
        |  Pause |Progress     |               |       |      |       |
        +========+=============+===============+       |      |       |
        |   Tree graph         | Payload       |       |      |       |
        |                      |               +=======+======+=======+
        |                      |               |  Target info         |
        |                      |               |                      |
        |                      |               |                      |
        +======================+===============+======================+

        -->
        <tr>
            <h1>Kitty Fuzzer <div id="fuzzer_version" style="display:inline"></div> - <div id="fuzzer_name" style="display:inline">Ragnar</div></h1>
            <h3  align="center" id="error_message"></h3>
        </tr>
        <table class="table table-main-layout">
            <tr>
                <td colspan="2">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Session Info</div>
                        <table class="table table-hover table-striped table-responsive info-table">
                            <tr><td>Start Index</td><td id="start_index">N/A</td></tr>
                            <tr><td>Current Index</td><td id="current_index">N/A</td></tr>
                            <tr><td>End Index</td><td id="end_index">N/A</td></tr>
                            <!-- TODO: should be moved to reports -->
                            <tr><td>Failures</td><td id="failure_count">N/A</td></tr>
                            <tr><td>Start Time</td><td id="start_time">N/A</td></tr>
                            <tr><td>ETA</td><td id="eta">N/A</td></tr>
                        </table>
                        <table class="table table-hover table-striped table-responsive info-table">
                            <tr>
                                <td>
                                    <button id="pause_button" type="button" class="btn btn-default btn-danger"></button>
                                </td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-large progress-bar-danger" role="progress-bar" id="progress_bar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td colspan="5">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Fuzzing Stages</div>
                        <div>A graph of the stages should be drawn here</div>
                    </div>
                </td>
                <td colspan="3">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Reports</div>
                        <!-- TODO: replace with actual implementation -->
                        <lu id="reports" class="list-group reportlist"></lu>
                    </div>
                </td>
            </tr>
            <tr class="child">
                <td colspan="4">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Template Structure</div>
                        <div class="monospaced-text unknown-data-size" id="template_tree"></div>
                    </div>
                </td>
                <td colspan="3">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Current Payload</div>
                        <pre class="unknown-data-size" id="current_payload_hexdump"></pre>
                    </div>
                </td>
                <td colspan="3">
                    <div class="panel panel-danger">
                        <div class="panel-heading">Target Information</div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    <script>
        var state = {}
        state.start_time = null;
        state.failure_count = null;
        state.paused = null;
        state.current_payload = null;
        state.template_tree = null;

        function updateReports(reports) {
            $('#reports a').remove();
            if (reports.length > 0) {
                reports.sort(function(a, b){return a-b});
                $.each(reports, function(index, test_number) {
                    var link = '<a href="static/report.html?report_id=' + test_number + '" class="list-group-item list-group-item-danger">Report #' + test_number + '</a>';
                    //$('<li class="list-group-item list-group-item-danger">').append(link).appendTo('#reports');
                    $(link).appendTo('#reports');
                });    
            }
            reports = null;
        }

        function setPauseState(paused) {
            if(paused != state.paused)
            {
                var btn_text = (paused == true) ? 'Resume' : 'Pause';
                var btn_action = (paused == true) ? 'doResume();' : 'doPause();';
                $('#pause_button').text(btn_text);
                $('#pause_button').attr('onclick', btn_action);
                state.paused = paused;
            }            
        }

        function setErrorMessage(msg) {
            $('#error_message').text(msg);
        }

        function updateFieldFromDict(field, d)
        {
            if(state[field] != d[field])
            {
                state[field] = d[field];
                $('#' + field).text(state[field]);
            }
        }
        function updateStatsTable(stats) {
            if(stats.start_time != state.start_time)
            {
                updateTitle(stats.kitty_version)
                updateFieldFromDict('start_index', stats);
                updateFieldFromDict('end_index', stats);
                state.start_time = stats.start_time;
                $('#start_time').text(new Date(Math.floor(stats.start_time * 1000)).toISOString().slice(0,19).replace(/T|Z/g," "));    
            }
            updateFieldFromDict('failure_count', stats);
            updateFieldFromDict('current_index', stats);
        }

        function hex2a(hexx) {
            var hex = hexx.toString();//force conversion
            var str = '';
            for (var i = 0; i < hex.length; i += 2)
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            return str;
        }

        function updateCurrentPayload(test_details)
        {
            var curr = test_details['node/value/rendered/base64'];
            if(state.current_payload != curr)
            {
                $('#current_payload_hexdump').text(Hexdump.dump(atob(curr)))
                state.current_payload = curr;
            }
        }

        function updateTemplateTree(test_details)
        {
            var curr = test_details['node/tree'];
            if(state.template_tree != curr)
            {
                var tree = atob(curr);
                // fix lines
                // tree = tree.replace(/\n/g, '<br>');
                // fix spaces
                // tree = tree.replace(/ /g, '&nbsp;');
                
                $('#template_tree').html(tree);
                state.template_tree = curr;
            }
        }

        function setProgress(stats, eta) {
            var start = stats.start_index;
            var end = stats.end_index;
            var current = stats.current_index;
            var percent = Math.round(100.0 / (end - start) * (current - start));
            $('#progress_bar').text(percent + '%');
            $('#progress_bar').css('width', percent + '%').attr('aria-valuenow', percent); 
            //$('#progress_bar').css('width', percent).attr('aria-valuenow', percent);
            var msg;
            if (current >= end) {
                msg = 'Fuzzing session completed';
            }
            else {
                msg = eta;
            }
            $('#eta').text(msg);
        }

        function toTitleCase(str) {
            return str.replace(/_/g, ' ').replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        }

        function updateTestDetails(test_details) {
            //$('#current_test tr').remove();
            var keys = [];
            for (var prop in test_details) {
                keys.push(prop);
            }
            keys.sort();
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var value = test_details[key];
                var fkey = toTitleCase(key);
                var data_id = 'test_details_' + key.replace(/[()/\s]/g, '_');
                if($('#' + data_id).length == 0) {
                    $('<tr>').append($('<td>').text(fkey), $('<td>').addClass("value_cell").attr('id', data_id).text(value)).appendTo('#current_test');
                }
                else {
                    $('#' + data_id).text(value);
                }
            }
        }

        function doPause() {
            $.post('/api/action/pause');
            $('#pause_button').disabled = true;
        }

        function doResume() {
            $.post('/api/action/resume');
            $('#pause_button').disabled = true;
        }

        function updateTitle(version) {
            $('#fuzzer_version').text(version);
        }

        function processResponse(data) {
            setErrorMessage(' ');
            setPauseState(data.paused);
            updateStatsTable(data.stats);
            setProgress(data.stats, data.eta);
            // updateTestDetails(data.current_test);
            updateCurrentPayload(data.current_test);
            updateTemplateTree(data.current_test);
            // updateReports(data.reports);
            setTimeout(performUpdate, 3000);
        }

        function handleFailure() {
            setErrorMessage('Error communicating with fuzzer web server');
            setTimeout(performUpdate, 10000);
        }

        function performUpdate() {
            $.getJSON('api/stats.json', processResponse).fail(handleFailure);
        }

        setPauseState(false);
        performUpdate();

    </script>
</body>

</html>
